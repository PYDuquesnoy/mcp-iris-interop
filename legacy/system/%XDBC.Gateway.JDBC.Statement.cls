/* Copyright (c) 2025 by InterSystems Corporation.
   Cambridge, Massachusetts, U.S.A.  All rights reserved.
   Confidential property of InterSystems Corporation. */

/// FOR INTERNAL USE - do not invoke directly
Class %XDBC.Gateway.JDBC.Statement Extends %XDBC.Gateway.Statement [ System = 4 ]
{

Parameter CLOSECURRENTRESULT As Integer = 1;

Parameter KEEPCURRENTRESULT As Integer = 2;

Parameter CLOSEALLRESULTS As Integer = 3;

Parameter SUCCESSNOINFO As Integer = -2;

Parameter EXECUTEFAILED As Integer = -3;

Parameter RETURNGENERATEDKEYS As Integer = 1;

Parameter NOGENERATEDKEYS As Integer = 2;

Property connection As %XDBC.Gateway.JDBC.Connection;

Property statement As %ObjectHandle;

Method %OnNew(connection As %XDBC.Gateway.JDBC.Connection, statement As %ObjectHandle) As %Status
{
   set ..connection = connection
   set ..statement = statement
   return $$$OK
}

/// Sets the value of the designated parameter with the given object.
/// Method SetObject(parameterName As %String, parameter As %ObjectHandle) {}
/// Adds the given SQL command to the current list of commmands for this Statement object.
Method AddBatch(sql As %String)
{
    do ..connection.jdbcConnection.addBatch(..statement, sql)
}

/// Cancels this Statement object if both the DBMS and driver support aborting an SQL statement.
Method Cancel()
{
    do ..connection.jdbcConnection.cancelStatement(..statement)
}

/// Empties this Statement object's current list of SQL commands.
Method ClearBatch()
{
    do ..connection.jdbcConnection.clearBatch(..statement)
}

/// Releases this Statement object's database and JDBC resources immediately instead of waiting for this to happen when it is automatically closed.
Method Close()
{
    do ..connection.jdbcConnection.closeStatement(..statement)
}

/// Executes the given SQL statement, which may return multiple results, and signals the driver that any auto-generated keys should be made available for retrieval
/// xecutes the given SQL statement, which may return multiple results. In some (uncommon) situations, a single SQL statement may return multiple result sets and/or
/// update counts. Normally you can ignore this unless you are (1) executing a stored procedure that you know may return multiple results or (2) you are dynamically
/// executing an unknown SQL string. The execute method executes an SQL statement and indicates the form of the first result. You must then use the methods getResultSet 
/// or getUpdateCount to retrieve the result, and getMoreResults to move to any subsequent result(s).
/// Note:This method cannot be called on a PreparedStatement or CallableStatement.
Method Execute(sql As %String, autoGeneratedKeys As %Integer = "") As %Boolean
{
    return ..connection.jdbcConnection.execute(..statement, sql)
}

/// Submits a batch of commands to the database for execution and if all commands execute successfully, returns an array of update counts
Method ExecuteBatch() As %Library.ListOfDataTypes
{
    set counts = ..connection.jdbcConnection.executeBatch(..statement)
    return counts
}

/// list of int
/// Executes the given SQL statement, which returns a single ResultSet object
Method ExecuteQuery(sql As %String) As ResultSet
{
    new %objlasterror
    set externalResult = ..connection.jdbcConnection.executeQuery(..statement, sql)
    set result = ##class(%XDBC.Gateway.JDBC.ResultSet).%New(..connection, externalResult)
    if (result = $$$NULLOREF) {
        if $$$ISERR($get(%objlasterror,$$$OK)) {
            throw ##class(%Exception.StatusException).CreateFromStatus(%objlasterror)
        } else {
            throw ##class(%Exception.SQL).CreateFromSQLCODE(-400,"Unknown error encountered while executing external JDBC Query")
        }
    } elseif result.%SQLCODE < 0 {
        throw ##class(%Exception.SQL).CreateFromSQLCODE(result.%SQLCODE, result.%Message)
    }
    return result
}

/// Executes the given SQL statement, which may be an INSERT, UPDATE, or DELETE statement or an SQL statement that returns nothing, such as an SQL DDL statement
/// Executes the given SQL statement and signals the driver with the given flag about whether the auto-generated keys produced by this Statement object should be made available for retrieval.
/// Cannot be executed on PreparedStatement or CallableStatement.
Method ExecuteUpdate(sql As %String, autoGeneratedKeys As %Integer = 0) As %Integer
{
    set response = ..connection.jdbcConnection.executeUpdate(..statement, sql, autoGeneratedKeys)
    return response
}

/// Retrieves the Connection object that produced this Statement object
Method GetConnection() As Connection
{
    return ..connection
}

/// Retrieves the number of result set rows that is the default fetch size for ResultSet objects generated from this Statement object
Method GetFetchSize() As %Integer
{
    return ..connection.jdbcConnection.getFetchSize(..statement)
}

/// Retrieves any auto-generated keys created as a result of executing this Statement object
Method GetGeneratedKeys() As ResultSet
{
    set generatedKeys = ..connection.jdbcConnection.getGeneratedKeys(..statement)
    return ##class(ResultSet).%New(..connection, generatedKeys)
}

/// Retrieves the maximum number of bytes that can be returned for character and binary column values in a ResultSet object produced by this Statement object
Method GetMaxFieldSize() As %Integer
{
}

/// Retrieves the maximum number of rows that a ResultSet object produced by this Statement object can contain
Method GetMaxRows() As %Integer
{
}

/// Moves to this Statement object's next result, returns true if it is a ResultSet object, and implicitly closes any current ResultSet object(s) obtained with the method getResultSet.
Method GetMoreResults(option As %Integer) As %Boolean
{
    if $data(option) {
        set response = ..connection.jdbcConnection.getMoreResults(..statement)
    } else {
        set response = ..connection.jdbcConnection.getMoreResults(..statement, option)
    }
    return response
}

/// Retrieves the number of seconds the driver will wait for a Statement object to execute.
Method GetQueryTimeout() As %Integer
{
}

/// Retrieves the current result as a ResultSet object.
Method GetResultSet() As ResultSet
{
    set externalResult = ..connection.jdbcConnection.getResultZet(..statement)
    return ##class(ResultSet).%New(..connection, externalResult)
}

/// Retrieves the column metadata for the result set that will be returned for this statement as a ResultSetMetaData object.
Method GetResultSetMetaData() As %XDBC.Gateway.ResultSetMetaData
{
    // Get version of the client's result set metadata in case it's an older client
    try {
        set clientRSMDVersion = +..connection.jdbcConnection.getResultSetMetadataVersion()
    } catch {
        set clientRSMDVersion = 0
    }
    if clientRSMDVersion '= +$PARAMETER("%XDBC.Gateway.ResultSetMetaData", "SERVERRESULTSETMETADATAVERSION") {
        // Return blank metadata? The other option is to THROW an error
        return ##class(%XDBC.Gateway.ResultSetMetaData).%New("")
    }
    
    // %XDBC.Gateway.ResultSetMetaData:%OnNew() will look at the clientVersion and build the metadata object based on the correct $list format expected from the client
    return ##class(%XDBC.Gateway.ResultSetMetaData).%New(..connection.jdbcConnection.getResultSetMetaData(..statement))
}

/// Retrieves the current result as an update count; if the result is a ResultSet object or there are no more results, -1 is returned
Method GetUpdateCount() As %Integer
{
}

/// Retrieves whether this Statement object has been closed
Method IsClosed() As %Boolean
{
    return ..connection.jdbcConnection.isStatementClosed(..statement)
}

/// Gives the driver a hint as to the number of rows that should be fetched from the database when more rows are needed for ResultSet objects genrated by this Statement.
Method SetFetchSize(rows As %Integer)
{
    do ..connection.jdbcConnection.setFetchSize(..statement, rows)
}

/// Sets the limit for the maximum number of bytes that can be returned for character and binary column values in a ResultSet object produced by this Statement object.
Method SetMaxFieldSize(max As %Integer)
{
}

/// Sets the limit for the maximum number of rows that any ResultSet object generated by this Statement object can contain to the given number.
Method SetMaxRows(max As %Integer)
{
}

/// Sets the number of seconds the driver will wait for a Statement object to execute to the given number of seconds.
Method SetQueryTimeout(seconds As %Integer)
{
}

}
